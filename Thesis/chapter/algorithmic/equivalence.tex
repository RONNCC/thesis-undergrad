
\section{Equivalence to the Declarative System}

\todo{Intro to equivalence of systems.}

Note that subtyping extends to contexts in a straightforward way: $\ctx \subASing \ctx'$ if and only if $\ctx = c_1 : \typeList_1, \ldots, c_n : \typeList_n$, $\ctx' = c_1 : \typeListB_1, \ldots, c_n : \typeListB_n$, and $\typeList_i \subA \all{\typeListB_i}$ for all $i \in \set{1, \ldots, n}$.


\subsection{Soundness}

\begin{theorem}[Soundness of Algorithmic Typing]
  If $\typeRecAJ P c \typeList$, then $\typeRecD {\all\ctx} {\recCtx} {\erase P} c {\any \typeList}$.
\end{theorem}
\begin{proof}
  We proceed by induction on the typing derivation.
  \begin{description}
    % Intersections
    \item[Case $\intersect\Right :$] This is one of the two tricky cases (the other is the dual $\union\Left$). In fact, this case is the reason we needed distributivity of intersection over union. Assume $\DD : \typeRecAJR \ctx P c {A, \typeList}$ and $\EE : \typeRecAJR \ctx P c {B, \typeList}$. We have the following derivation:
    $$ \infer[\irb{Sub}\Right]{\typeRecAJR {\all\ctx} P c {\any{\parens{A \intersect B, \typeList}}}}
        { \infer[\intersect\Right]{\typeRecAJR {\all\ctx} P c {(A \union \any\typeList) \intersect (B \union \any\typeList)}}
           { \deduce[\induction{(\DD)}]{\typeRecAJR {\all\ctx} P c {A \union \any\typeList}} {}
           & \deduce[\induction{(\EE)}]{\typeRecAJR {\all\ctx} P c {B \union \any\typeList}} {}
           }
        & \deduce[\text{\Cref{refinements:distributivity-proof}}]{\ldots \subASing \ldots}{}
        }
    $$
    where \cref{refinements:distributivity-proof} is used to prove $(A \union \any\typeList) \intersect (B \union \any\typeList) \subASing (A \intersect B) \union \any\typeList$.

    \item[Case $\intersect\Left :$] Follows from $\irb{Sub}\Left$ (we need subtyping to reorder the large intersection) and the induction hypothesis.

    % Unions
    \item[Case $\union\Right :$] Follows from $\irb{Sub}\Right$ (to reorder the large union) and the induction hypothesis.
    \item[Case $\union\Left :$] Similar to $\intersect\Right$.

    % Recursive types
    \item[Case $\mu\Right, \mu\Left :$] Follows immediately from $\irb{Sub}\Right$ and $\irb{Sub}\Left$, respectively.

    % id and cut
    \item[Case $\id :$] Follows by an application of $\irb{Sub}\Right$ and $\id$. We note that if $\typeList \subA \typeListB$, then $\all\typeList \subASing \any\typeListB$ by a trivial induction on the sum of the number of types in $\typeList$ and $\typeListB$.
    \item[Case $\cut :$] Follows immediately from $\cut$ and the two induction hypotheses.

    % Structural rules
    \item[Case $\terminate\Right, \tensor\Right, \internal\Right, \lolli\Right, \external\Right :$] Follows from $\irb{Sub}\Right$ to ``pick out the right type'' followed by the corresponding rule in the declarative system.
    \item[Case $\terminate\Left, \tensor\Left, \internal\Left, \lolli\Left, \external\Left :$] Follows from $\irb{Sub}\Left$ to ``pick out the right type'' followed by the corresponding rule in the declarative system.
    \todo{Recursive types?}
  \end{description}
\end{proof}


\subsection{Completeness}

\begin{lemma}[Completeness of Delegation]
  \label{algorithmic:delegation-sub}
  \todo{What to call this?}
  The following are admissible:
  \begin{itemize}
    \item If $\typeRecAJ P c \typeList$ and $\typeList \subA \typeList'$ then $\typeRecAJ P c {\typeList'}$.
    \item If $\typeRecAJR {\ctx, d : \typeList} P c \typeListB$ and $\typeList' \subA \typeList$ then $\typeRecAJR {\ctx, d : \typeList'} P c \typeListB$.
  \end{itemize}
  Note that $P$ stays the same, which means we do not need to change type annotations.
\end{lemma}
\begin{proof}
  By induction on the structure of $P$ and appealing to \cref{algorithmic:interpretation-commutes}. Since both parts of the theorem are similar, we only show the former. Assume $\typeRecAJ P c \typeList$ and $\typeList \subA \typeList'$. By \cref{algorithmic:interpretation-commutes}, we know
  $$ \interpP {\typeRecAJ P c \typeList}
    \iff \interp \typeList {\lam A { \interpC \ctx {\lam {\ctx'} {\typeRecAJRStruct {\ctx'} P c A}} }}
  $$
  and
  $$ \interpP {\typeList \subA \typeList'}
     \iff \interpC \typeList {\lam A {\interp {\typeList'} {\lam {A'} {A \subAStruct A'}} }}.
  $$
  By \cref{algorithmic:interpretation-mix}, it suffices to show
  $$
    \typeRecAJStruct P c A \wedge \interp {\typeList'} {\lam {A'} {A \subAStruct A'}}
    \implies \interp {\typeList'} {\lam {A'} {\typeRecAJStruct P c {A'}} }
  $$
  for some $A \in \typesStruct$. Similarly, by \cref{algorithmic:interpretation-connectives}, it suffices to show
  $$
    \typeRecAJStruct P c A \wedge A \subAStruct A'
    \implies \typeRecAJStruct P c {A'}
  $$
  for some $A' \in \typesStruct$. Assume $\DD : \typeRecAJStruct P c A$ and $\EE : A \subAStruct A'$. We use inversion on $\DD$:
  \begin{description}
    \item[Case $\id :$] Follows from the transitivity of $\subA$.
    \item[Case $\cut :$] We have
      $$ \DD = \vcenter{
          \infer[\cut]{\typeRecAJR {\ctx_1, \ctx_2} {\tspawnType d Q B {P'}} c A}
           { \DD_1 : \typeRecAJR {\ctx_1} Q d B
           & \DD_2 : \typeRecAJR {\ctx_2, d : B} Q d A
           }
         }
      $$
      The induction hypothesis on $\DD_2$ and $\EE$ gives $\typeRecAJR {\ctx_2, d : B} Q d {A'}$. $\cut$ on this and $\DD_1$ gives the result.
    \item[Case $\terminate\Right, \tensor\Right, \internal\Right, \lolli\Right, \external\Right :$] Inversion on $\EE$ gives the necessary subtyping relation(s). We match these with the sub-derivations from $\DD$ which lets us apply the induction hypotheses. The result follows from the same rule using these.
    \item[Case $\terminate\Left, \tensor\Left, \internal\Left, \lolli\Left, \external\Left :$] Follows immediately from the induction hypotheses.

    \item[Case $\mu, \procVar :$] \todo{Recursive processes.}
  \end{description}
\end{proof}


\begin{theorem}[Completeness of Algorithmic Typing]
  If $\typeRecDJ P c A$, then there exists $P'$ such that $\erase{P'} = P$ and $\typeRecAJ {P'} c A$.
\end{theorem}
\begin{proof}
  We proceed by induction on the typing derivation.
  \begin{description}
    % id and cut
    \item[Case $\id :$] We use $\id$ and the fact that $\subASing$ is reflexive.
    \item[Case $\cut :$] Follows from $\cut$ and the two induction hypotheses. We use the type from the derivation of the first branch to annotate $P$.

    % Structural rules
    \item[Case $\terminate\Right, \tensor\Right, \internal\Right, \lolli\Right, \external\Right :$] Follows immediately from the corresponding rule and the induction hypotheses.
    \item[Case $\terminate\Left, \tensor\Left, \internal\Left, \lolli\Left, \external\Left :$] Follows immediately from the corresponding rule and the induction hypotheses.

    % Subtyping
    \item[Case $\irb{Sub}\Right, \irb{Sub}\Left :$] Follows from the induction hypothesis and \cref{algorithmic:delegation-sub}.

    % Intersection and union
    \item[Case $\intersect\Right :$] \todo{This branch is tricky since we have to combine two annotations.}
    \item[Case $\union\Left :$] \todo{This branch is tricky since we have to combine two annotations.}

    \todo{Recursive types?}
  \end{description}

\end{proof}
